(async function POAutoSetup() { 

    if (!location.href.includes("#/procurement/purchase-order")) {
        throw new Error("âŒ Not on PO screen");
    }

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    async function waitUntil(conditionFn, timeout = 10000) {
        const start = Date.now();
        while (!conditionFn()) {
            if (Date.now() - start > timeout) {
                throw new Error("âŒ Timeout waiting");
            }
            await wait(100); // slightly faster polling
        }
    }

    async function selectCustomDropdown(containerId, value) {

        const container = document.querySelector("#" + containerId);
        if (!container) throw new Error("âŒ Dropdown not found: " + containerId);

        container.querySelector(".dropdown-toggle").click();
        await wait(200); // reduced from 400

        const searchInput = container.querySelector("#txtCustomSelectSearchText input");

        searchInput.focus();
        searchInput.value = value;
        searchInput.dispatchEvent(new Event("input", { bubbles: true }));
        searchInput.dispatchEvent(new Event("change", { bubbles: true }));

        await waitUntil(() =>
            [...container.querySelectorAll("ul li a")]
                .some(opt => opt.innerText.toLowerCase().includes(value.toLowerCase()))
        );

        const matched = [...container.querySelectorAll("ul li a")]
            .find(opt => opt.innerText.toLowerCase().includes(value.toLowerCase()));

        if (!matched) throw new Error("âŒ Value not found: " + value);

        matched.click();
    }

    console.log("ðŸš€ Starting Static PO Setup...");

    await selectCustomDropdown(
        "party_id",
        "INTERNATIONAL TRIMMINGS & LABELS INDIA P. LTD."
    );

    console.log("â³ Waiting for supplier rebind...");
    await wait(2000); // reduced from 2500

    await selectCustomDropdown("ship_address_id", "C-122");
    await selectCustomDropdown("indent_type", "Production Order");
    await selectCustomDropdown("item_group_type", "packing");
    await selectCustomDropdown("template_name", "Purchase Order");

    console.log("ðŸ“¦ Header setup complete. Opening detail modal...");

    const addButton = document.querySelector("#detail_collapsible_panel_open_popup_po_dt");
    if (!addButton) throw new Error("âŒ Add New button not found");

    addButton.scrollIntoView({ behavior: "instant", block: "center" });
    await wait(300); // reduced

    addButton.click();

    await waitUntil(() => document.querySelector(".modal-content"));

    console.log("âœ… PO Detail Modal Opened Successfully");

})();
